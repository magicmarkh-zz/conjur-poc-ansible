---
# tasks file for follower
- name: pull dap container image
  docker_image:
    name: "{{dap_image_name}}"
    tag: "{{dap_version}}"
    source: pull
  when: inventory_hostname in groups['followers']

- name: start dap follower container
  docker_container:
    name: "{{dap_follower_name}}"
    image: "{{dap_image_name}}:{{dap_version}}"
    restart_policy: always
    security_opts:
      - "seccomp:unconfined"
    ports:
      - "5432:5432"
      - "443:443"
    volumes:
      - seed:/seed
  when: inventory_hostname in groups['followers']

- name: get seed file
  command: docker exec {{ dap_master_container_name }} evoke seed follower {{ dap_follower_name }} 
  register: seed
  when: inventory_hostname in groups['masters']

- name: create seed file on follower machine
  copy:
    content: "{{hostvars['cent']['seed']['stdout']}}"
    dest: /var/lib/docker/volumes/seed/_data/seed.tar
  when: inventory_hostname in groups['followers']

- name: load seed file into container
  command: docker exec -i {{ dap_follower_name }} evoke unpack seed /seed/seed.tar
  when: inventory_hostname in groups['followers']

- name: configure container as follower
  command: docker exec {{ dap_follower_name }} evoke configure follower
  when: inventory_hostname in groups['followers']

- name: delete seed file
  file:
    path: /var/lib/docker/volumes/policy/_data/seed.tar
    state: absent
  when: inventory_hostname in groups['followers']